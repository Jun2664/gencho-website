name: ğŸš€ Deploy to Production

on:
  # ã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  push:
    branches: [main]

  # WordPressæ›´æ–°æ™‚ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  repository_dispatch:
    types: [wordpress-update]

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      reason:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç†ç”±'
        required: false
        default: 'æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ“¦ Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci

    - name: ğŸ—ï¸ ã‚µã‚¤ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
      run: npm run build
      env:
        NODE_ENV: production

    - name: ğŸ“ publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’outã«ã‚³ãƒ”ãƒ¼
      run: |
        echo "ğŸ“ public/ã®å†…å®¹ã‚’out/ã«ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™..."
        # index.htmlä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¼·åˆ¶çš„ã«ä¸Šæ›¸ãã‚³ãƒ”ãƒ¼
        rsync -av --exclude='index.html' public/ out/
        echo "âœ… ã‚³ãƒ”ãƒ¼å®Œäº†"
        echo ""
        echo "ğŸ“Š ã‚³ãƒ”ãƒ¼å¾Œã®out/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:"
        ls -lh out/img/*.png | head -5

    - name: ğŸ“Š ãƒ“ãƒ«ãƒ‰çµæœã‚’ç¢ºèª
      run: |
        echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
        ls -la out/
        echo ""
        echo "ğŸ“„ ãƒ–ãƒ­ã‚°ãƒšãƒ¼ã‚¸ç¢ºèª:"
        ls -la out/blog/ 2>/dev/null || echo "ãƒ–ãƒ­ã‚°ãƒ•ã‚©ãƒ«ãƒ€ã¯ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"

    - name: ğŸš€ æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./out/
        server-dir: /public_html/gencho.site/
        dangerous-clean-slate: true
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/Thumbs.db
          cms/**

    - name: ğŸ¨ WordPressãƒ†ãƒ¼ãƒãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
      if: hashFiles('wordpress-theme/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./wordpress-theme/
        server-dir: /public_html/gencho.site/cms/wp-content/themes/gencho-corporate/
        exclude: |
          **/.git*
          **/.git*/**
      continue-on-error: true

    - name: âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      if: success()
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸŒ ã‚µã‚¤ãƒˆURL: ${{ secrets.SITE_URL || 'https://gencho.site' }}"
        echo ""
        echo "ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
        echo "- ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}"
        if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
          echo "- WordPressã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${{ github.event.client_payload.action }}"
          echo "- è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.client_payload.post_title }}"
        fi
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "- ç†ç”±: ${{ github.event.inputs.reason }}"
        fi

    - name: âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
      if: failure()
      run: |
        echo "ğŸ’¥ ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"